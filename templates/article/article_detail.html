{% extends "base.html" %}  

{% block headblock %}
{% load static %}
  <link rel="stylesheet" href="{% static 'css/article_detail.css' %}">
  <link href="{% static 'mdeditor/css/editormd.min.css' %}" rel="stylesheet">
  <link href="{% static 'mdeditor/css/editormd.preview.css' %}" rel="stylesheet">
{% endblock headblock %}

{% block content %}

<div class="article-details-container">

    <div class="article-header">
      <h1 class="article-title">{{ article.title }}</h1>

      <div class="article-actions">

        {% if article.state == 'r' and can_edit_as_editor %}
          <a href="{% url 'article-update' article.id %}" class="detail-link">Editar como editor</a>
        {% elif article.state == 'd' and can_edit_as_author %}
          <a href="{% url 'article-update' article.id %}" class="detail-link">Editar como autor</a>
        {% endif %}

        {% if can_edit and article.state == 'i' or can_edit and article.state == 'r' %}
          <a href="{% url 'article-to-draft' pk=article.id %}" class="detail-link">Pasar a Borrador</a>
        {% endif %}

        {% if can_edit and article.state == 'p' or can_edit and article.state == 'd' %}
          <a href="{% url 'article-to-revision' pk=article.id %}" class="detail-link">Pasar a Revisi칩n</a>
        {% endif %}
        
        {% if can_publish %}
          {% if not is_moderated_category and article.state != 'p' %}
            <a href="{% url 'article-to-published' pk=article.id %}" class="detail-link">Publicar</a>
          {% elif article.state == 'r' %}
            <a href="{% url 'article-to-published' pk=article.id %}" class="detail-link">Publicar</a>
          {% endif %}
        {% endif %}

        <!-- Display Inactivate option only for Admin or Author roles -->
        {% if can_inactivate and article.state != 'i' %}
          <a href="{% url 'article-to-inactive' pk=article.id %}" class="detail-link">Inactivar</a>
        {% endif %}
        
      </div>

      <div>
        <h2 class="article-title">Descripci칩n</h2>
        <p class="article-description">{{ article.description }}</p>
      </div>

      <div>
        <h2 class="article-title">Categor칤a</h2>
        <p class="article-description">{{ article.category.name }}</p>
      </div>

      <div>
        <h2 class="article-title">Autor</h2>
        <p class="article-description">{{ article.autor.username }}</p>
      </div>

      <div>
        <h2 class="article-title">Estado</h2>
        <p class="article-description">
          {% if article.state == 'd' %}
            Borrador
          {% elif article.state == 'p' %}
            Publicado
          {% elif article.state == 'i' %}
            Inactivo
          {% elif article.state == 'r' %}
            Revisi칩n
          {% endif %}
        </p>
      </div>

      <div>
        <h2 class="article-title">Visualizaciones</h2>
        <p class="article-description">{{ article.views_number }}</p>
      </div>

      <div>
        {% if authenticated %}
          <h2 class="article-title">Votos</h2>
          <p class="article-description">
            Me gusta: {{ article.likes_number }} 
            <a href="{% url 'like-article' article.id %}" class="btn btn-success">游녨</a>
            No me gusta: {{ article.dislikes_number }} 
            <a href="{% url 'dislike-article' article.id %}" class="btn btn-danger">游녩</a>
          </p>
        {% endif %}
      </div>

      <div>
        {% if authenticated %}
          <h2 class="article-title">Votar art칤culo</h2>
          {% if user_rating %}
            <p>Has calificado este art칤culo con {{ user_rating.rating }} estrellas.</p>
            <form method="POST">
              {% csrf_token %}
              <label for="rating">Cambiar calificaci칩n:</label>
              <select name="rating" id="rating">
                <option value="1" {% if user_rating.rating == 1 %}selected{% endif %}>1 Estrella</option>
                <option value="2" {% if user_rating.rating == 2 %}selected{% endif %}>2 Estrellas</option>
                <option value="3" {% if user_rating.rating == 3 %}selected{% endif %}>3 Estrellas</option>
                <option value="4" {% if user_rating.rating == 4 %}selected{% endif %}>4 Estrellas</option>
                <option value="5" {% if user_rating.rating == 5 %}selected{% endif %}>5 Estrellas</option>
              </select>
              <button type="submit" class="btn btn-primary">Actualizar</button>
            </form>
          {% else %}
            <form method="POST">
              {% csrf_token %}
              <label for="rating">Calificar:</label>
              <select name="rating" id="rating">
                <option value="1">1 Estrella</option>
                <option value="2">2 Estrellas</option>
                <option value="3">3 Estrellas</option>
                <option value="4">4 Estrellas</option>
                <option value="5">5 Estrellas</option>
              </select>
              <button type="submit" class="btn btn-primary">Enviar</button>
            </form>
          {% endif %}
        {% endif %}
      </div>

      <div>
        <h2 class="article-title">Promedio de calificaci칩n</h2>
        {% if avg_rating %}
          <p>Este art칤culo tiene una calificaci칩n promedio de {{ avg_rating }} estrellas.</p>
        {% else %}
          <p>Este art칤culo a칰n no tiene calificaciones.</p>
        {% endif %}
      </div>

      <!-- Display the user's last rating -->
      {% if user_vote and user_vote.rating %}
      <div>
        <p>Tu 칰ltima calificaci칩n fue de {{ user_vote.rating }} estrellas.</p>
      </div>
      
{% endif %}

    </div>

    <div class="article-body">{{ article_render_content|safe }}</div>

    <div class="article-history">
      {% if can_edit %}
        <a href="{% url 'article-update-history' article.id %}" class="detail-link">Ver historial de cambios</a>
      {% endif %}
      <a href="{% if request.GET.from == 'home' %}{% url 'home' %}{% else %}{% url 'article-list' %}{% endif %}" class="detail-link">
        {% if request.GET.from == 'home' %}
          Volver a la p치gina principal
        {% else %}
          Volver a la lista
        {% endif %}
      </a>
    </div>
</div>

{% endblock content %}
