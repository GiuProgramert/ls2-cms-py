{% extends "base.html" %}  

{% block headblock %}
{% load static %}
  <link rel="stylesheet" href="{% static 'css/article_detail.css' %}">
  <link href="{% static 'mdeditor/css/editormd.min.css' %}" rel="stylesheet">
  <link href="{% static 'mdeditor/css/editormd.preview.css' %}" rel="stylesheet">
{% endblock headblock %}

{% block content %}

<div class="article-details-container">
  <div class="article-actions">
    {% if article.state == 'r' and can_edit_as_editor %}
      <a href="{% url 'article-update' article.id %}" class="detail-link">Editar como editor</a>
    {% elif article.state == 'd' and can_edit_as_author %}
      <a href="{% url 'article-update' article.id %}" class="detail-link">Editar como autor</a>
    {% endif %}

    {% if can_edit_as_author and article.state == 'i' or can_edit_as_editor and article.state == 'r' %}
      <form method="POST" action="{% url 'article-to-draft' pk=article.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">Pasar a Borrador</button>
        <label for="custom_message">Mensaje personalizado (opcional):</label>
        <textarea id="custom_message" name="custom_message" rows="4" cols="50"></textarea>
      </form>
    {% endif %}

    {% if can_publish and article.state == 'e' or can_edit_as_author and article.state == 'd' %}
      <form method="POST" action="{% url 'article-to-revision' pk=article.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">Pasar a Revisi칩n</button>
        <label for="custom_message">Mensaje personalizado (opcional):</label>
        <textarea id="custom_message" name="custom_message" rows="4" cols="50"></textarea>
      </form>
    {% endif %}

    {% if can_edit_as_editor and article.state == 'r' %}
      <form method="POST" action="{% url 'article-to-edited' pk=article.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">Pasar a Editado</button>
        <label for="custom_message">Mensaje personalizado (opcional):</label>
        <textarea id="custom_message" name="custom_message" rows="4" cols="50"></textarea>
      </form>
    {% endif %}

    
    {% if can_publish or is_author %}
      {% if not is_moderated_category and article.state != 'p' and is_author %}
        <form method="POST" action="{% url 'article-to-published' pk=article.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary">Publicar</button>
          <label for="custom_message">Mensaje personalizado (opcional):</label>
          <textarea id="custom_message" name="custom_message" rows="4" cols="50"></textarea>
        </form>
      {% elif article.state == 'e' and not is_author %}
        <form method="POST" action="{% url 'article-to-published' pk=article.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary">Publicar</button>
          <label for="custom_message">Mensaje personalizado (opcional):</label>
          <textarea id="custom_message" name="custom_message" rows="4" cols="50"></textarea>
        </form>
      {% elif not is_moderated_category and article.state != 'p' and is_admin %}
        <form method="POST" action="{% url 'article-to-published' pk=article.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary">Publicar</button>
          <label for="custom_message">Mensaje personalizado (opcional):</label>
          <textarea id="custom_message" name="custom_message" rows="4" cols="50"></textarea>
        </form>
      {% endif %}
    {% endif %}

    <!-- Display Inactivate option only for Admin or Author roles -->
    {% if can_inactivate and article.state != 'i' %}
      <form method="POST" action="{% url 'article-to-inactive' pk=article.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">Inactivar</button>
        <label for="custom_message">Mensaje personalizado (opcional):</label>
        <textarea id="custom_message" name="custom_message" rows="4" cols="50"></textarea>
      </form>
    {% endif %}
    
  </div>
  <br>
  <br>

    <!-- T칤tulo del art칤culo -->
    <div class="article-header">
      <h1 class="text-3xl font-bold mb-4">{{ article.title }}</h1>

      <!-- Tabla con informaci칩n del art칤culo -->
      <table class="min-w-full table-auto bg-white shadow-md rounded-lg overflow-hidden">
        <tbody>
          <tr class="bg-gray-100">
            <th class="text-left p-4">Descripci칩n</th>
            <td class="p-4">{{ article.description }}</td>
          </tr>
          <tr>
            <th class="text-left p-4">Categor칤a</th>
            <td class="p-4">{{ article.category.name }}</td>
          </tr>
          <tr class="bg-gray-100">
            <th class="text-left p-4">Autor</th>
            <td class="p-4">{{ article.autor.username }}</td>
          </tr>
          <tr>
            <th class="text-left p-4">Estado</th>
            <td class="p-4">
              {{ article.get_state_display }}
            </td>
          </tr>
          <tr class="bg-gray-100">
            <th class="text-left p-4">Visualizaciones</th>
            <td class="p-4">{{ article.views_number }}</td>
          </tr>
        </tbody>
      </table>

      <!-- Votos -->
      <div class="mt-8">
        {% if authenticated %}
          <h2 class="text-2xl font-semibold mb-4">Votos del art칤culo</h2>
          <div class="flex items-center space-x-4">
            <span class="text-lg">Me gusta: {{ article.likes_number }}</span>
            <a href="{% url 'like-article' article.id %}" class="btn btn-success">游녨</a>
            <span class="text-lg">No me gusta: {{ article.dislikes_number }}</span>
            <a href="{% url 'dislike-article' article.id %}" class="btn btn-danger">游녩</a>
          </div>
          <br>
        {% endif %}
      </div>

      <!-- Votar art칤culo -->
      {% if authenticated %}
        <div class="mt-8">
          <h2 class="text-2xl font-semibold mb-4">Votar art칤culo</h2>
          {% if user_rating %}
            <p>Has calificado este art칤culo con {{ user_rating.rating }} estrellas.</p>
            <form method="POST" class="mt-4">
              {% csrf_token %}
              <label for="rating">Cambiar calificaci칩n:</label>
              <select name="rating" id="rating" class="border border-gray-300 rounded px-3 py-2">
                {% for i in "12345" %}
                  <option value="{{ i }}" {% if user_rating.rating == i %}selected{% endif %}>{{ i }} Estrella{{ i|pluralize }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="btn btn-primary ml-4">Actualizar</button>
            </form>
          {% else %}
            <form method="POST" class="mt-4">
              {% csrf_token %}
              <label for="rating">Calificar:</label>
              <select name="rating" id="rating" class="border border-gray-300 rounded px-3 py-2">
                {% for i in "12345" %}
                  <option value="{{ i }}">{{ i }} Estrella{{ i|pluralize }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="btn btn-primary ml-4">Enviar</button>
            </form>
          {% endif %}
        </div>
        <br>
      {% endif %}

      <!-- Promedio de calificaci칩n -->
      <div class="mt-8">
        <h2 class="text-2xl font-semibold mb-4">Promedio de calificaci칩n</h2>
        {% if avg_rating %}
          <p>Este art칤culo tiene una calificaci칩n promedio de {{ avg_rating }} estrellas.</p>
        {% else %}
          <p>Este art칤culo a칰n no tiene calificaciones.</p>
        {% endif %}
      </div>

      <!-- Historial de cambios y enlaces de navegaci칩n -->
      <div class="mt-8">
        {% if can_edit %}
          <a href="{% url 'article-update-history' article.id %}" class="detail-link">Ver historial de cambios</a>
        {% endif %}
        <a href="{% if request.GET.from == 'home' %}{% url 'home' %}{% else %}{% url 'article-list' %}{% endif %}" class="detail-link">
          {% if request.GET.from == 'home' %}
            Volver a la p치gina principal
          {% else %}
            Volver a la lista
          {% endif %}
        </a>
      </div>
    </div>
    <br>
    <br>

    <!-- Renderizado del contenido del art칤culo -->
    <h2 class="text-2xl font-semibold mb-4">ARTICULO SOBRE: {{ article.title }}</h2>
    <div class="article-body mt-12 bg-white p-8 rounded-lg shadow">{{ article_render_content|safe }}</div>

    <!-- Secci칩n de comentarios de Disqus -->
    <div id="disqus_thread" class="mt-12"></div>
    <script>
        (function() { 
          var d = document, s = d.createElement('script');
          s.src = 'https://cmspy.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
</div>
<script id="dsq-count-scr" src="//cmspy.disqus.com/count.js" async></script>
{% endblock content %}
