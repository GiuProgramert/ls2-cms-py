{% extends "base.html" %} 

{% block headblock %}

{% load static %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">

{% endblock headblock %}

{% block content %}

<section class="articles">
      
  {% if featured_articles %}
  <div class="section-header normal-header">
    <h3>Art√≠culos Destacados</h3>
  </div>
  <br>
  <div class="slideshow-container">
    <a class="prev" onclick="plusSlides(-1)">&#10094;</a>

    {% for article in featured_articles %}
    
      <div class="mySlides fade">
        <img class="carousel" src="{{ article.image_url }}">
        <div class="text">
          <a href="{% url 'article-detail' article.id %}?from=home">{{ article.title }}</a>
          <p>{{ article.description }}</p>
        </div>
      </div>
    {% endfor %}

    <a class="next" onclick="plusSlides(1)">&#10095;</a>
  </div>
  <br>

  <!-- The dots/circles -->
  <div style="text-align:center">
    {% for article in featured_articles %}
      <span class="dot" onclick="currentSlide({{ forloop.counter }})"></span>
    {% endfor %}
  </div>
  {% endif %}
</section>
<main class="main-container">
  
  <section class="filters">
    <!-- Bot√≥n con √≠cono de filtro -->
    <button id="filterToggle" class="filter-button">
      <i class="fas fa-filter"></i> Filtrar
    </button>

    <!-- Cuadro de filtros, inicialmente oculto -->
    <div id="filterPanel" class="filter-panel" style="display: none;">
      <form method="get" action="{% url 'home' %}" class="filter-form">
        <div class="form-group">
          <label for="tags">Filtrar por tag:</label>
          {{ form.tags }}
        </div>

        <div class="form-group">
          <label for="category">Filtrar por categor√≠a:</label>
          {{ form.category }}
        </div>

        <div class="form-group">
          <label for="category_type">Filtrar por tipo de categor√≠a:</label>
          {{ form.category_type }}
        </div>

        <button type="submit" class="btn btn-primary" onclick="applyFilters()">Aplicar Filtros</button>
      </form>
    </div>
  </section>

  <form method="get" action="{% url 'home' %}" class="filter-bar">
    <!-- Bot√≥n para alternar entre ascendente y descendente -->
    <button type="button" class="toggle-order" onclick="toggleOrderDirection()">
      {% if order_direction == 'asc' %}
          ‚ñ≤ Asc
      {% else %}
          ‚ñº Des
      {% endif %}
    </button>
    
    <!-- Campo para ordenar por fecha, visualizaciones, etc. -->
    <select name="order_by" onchange="this.form.submit()">
      <option value="published_at" {% if order_by == 'published_at' or order_by == '-published_at' %}selected{% endif %}>Fecha</option>
      <option value="likes_number" {% if order_by == 'likes_number' or order_by == '-likes_number' %}selected{% endif %}>Likes</option>
      <option value="views_number" {% if order_by == 'views_number' or order_by == '-views_number' %}selected{% endif %}>Visualizaciones</option>
    </select>
    
    <!-- Campo para filtrar por rango de tiempo -->
    <select name="time_range" onchange="this.form.submit()">
        <option value="all" {% if time_range == 'all' %}selected{% endif %}>Sin l√≠mite</option>
        <option value="1h" {% if time_range == '1h' %}selected{% endif %}>√öltima hora</option>
        <option value="24h" {% if time_range == '24h' %}selected{% endif %}>√öltimas 24 horas</option>
        <option value="7d" {% if time_range == '7d' %}selected{% endif %}>√öltimos 7 d√≠as</option>
        <option value="30d" {% if time_range == '30d' %}selected{% endif %}>√öltimos 30 d√≠as</option>
        <option value="365d" {% if time_range == '365d' %}selected{% endif %}>√öltimos 365 d√≠as</option>
    </select>

    <!-- Se ejecuta cuando se seleccionan las opciones -->
    <noscript>
        <button type="submit" onclick="applyFilters()">Aplicar</button>
    </noscript>
</form>
<!--Resultados de busquedas o filtros-->

{% if filter_active %}
  <section class="articles">
    <div class="section-header normal-header">
      <h3>Art√≠culos encontrados</h3>
    </div>
    {% if all_articles %}
      {% for article in all_articles %}
        <div class="article-card">
          <a href="{% url 'article-detail' article.id %}?from=home">
            <h2 class="article-title">{{ article.title }}</h2>
          </a>
          <img class="articulos" src="{{ article.image_url }}" >
        
          <p class="author">Autor: {{ article.autor.username }}</p>
          <p class="description">{{ article.description }}</p>
          <div class="article-actions">
            <span><i class="fas fa-eye"></i> {{ article.views_number }}</span>
            <span><i class="fas fa-share"></i> {{ article.shares_number }}</span>
            <span><i class="fas fa-thumbs-up"></i> {{ article.likes_number }}</span>
            <span><i class="fas fa-thumbs-down"></i> {{ article.dislikes_number }}</span>
            <span>
          </div>

          <div class="article-tags">
            <strong>Tags:</strong>
            {% if article.tags.all %}
              {% for tag in article.tags.all %}
                <span class="tag">{{ tag.name }}</span>
              {% endfor %}
            {% else %}
              No hay tags asignados
            {% endif %}
          </div>

          <div>
            <p>Promedio de calificaci√≥n: 
            {% if article.avg_rating %}
              {{ article.avg_rating }} estrellas
            {% else %}
              No calificado
            {% endif %}
            </p>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <!-- Mostrar un mensaje si no se encuentran art√≠culos -->
      <p class="no-results-message">No se encontraron art√≠culos que coincidan con los filtros aplicados.</p>
    {% endif %}
  </section>
  <aside class="categories">
    <form method="get" action="{% url 'home' %}" class="search-form">
      <input 
          type="text" 
          name="search" 
          placeholder="Buscar art√≠culos..." 
          value="{{ search_query }}" 
          class="search-input">
      <button type="submit" class="search-button">
          <i class="fas fa-search"></i>
      </button>
      </form>
      <div class="category-section">
          <h3>Categor√≠as - Free</h3>
          {% for category in permited_categories %}
            {% if category.type == 'free' %}
              {% if 'ver_categorias_suscriptor' in permisos%}
                <div class="category-header">
                  <p class="category-name">{{ category.name }}</p>
                  <button class="favorite-btn" data-category-id="{{ category.id }}">
                    {% if category.id in favorite_categories %}
                        üíñ
                    {% else %}
                        ü§ç
                    {% endif %}
                  </button>
                </div>
              {% else %}
                <p class="category-name">{{ category.name }}</p>
              {% endif %}
            {% endif %}
          {% endfor %}
      </div>
      <div class="category-section">
          <h3>Categor√≠as - Suscriptor</h3>
          {% for category in permited_categories %}
            {% if category.type == 'suscription' %}
              <div class="category-header">
                <p class="category-name">{{ category.name }}</p>
                <button class="favorite-btn" data-category-id="{{ category.id }}">
                  {% if category.id in favorite_categories %}
                      üíñ
                  {% else %}
                      ü§ç
                  {% endif %}
                </button>
              </div>
            {% endif %}
          {% endfor %}
          {% for category in not_permited_categories %}
            {% if category.type == 'suscription' %} 
              <p>üîí {{category.name}}</p>
            {% endif %}
          {% endfor %}
      </div>
      <div class="category-section">
          <h3>Categor√≠as - Pagas</h3>
          {% for category in permited_categories %}
            {% if category.type == 'pay' %}
              <div class="category-header">
                <p class="category-name">{{ category.name }}</p>
                <button class="favorite-btn" data-category-id="{{ category.id }}">
                  {% if category.id in favorite_categories %}
                      üíñ
                  {% else %}
                      ü§ç
                  {% endif %}
                </button>
              </div>
            {% endif %}
          {% endfor %}

          {% for category in not_permited_categories %}
            {% if category.type == 'pay' %} 
            <p>üîí {{category.name}}</p>
            {% endif %}
          {% endfor %}
      </div>
  </aside>

{% else %}
  <!-- Atriculos de categorias favoritas -->
  {% if 'ver_categorias_suscriptor' in permisos and favorite_categories and favorite_articles %}
  <section class="articles">
      <div class="section-header favorite-header">
        <h3>Art√≠culos de Categor√≠as Favoritas</h3>
      </div>
      {% if favorite_articles %}
        {% for article in favorite_articles %}
        <div class="article-card">
          <a href="{% url 'article-detail' article.id %}?from=home">
            <h2 class="article-title">{{ article.title }}</h2>
          </a>
          <img class="articulos" src="{{ article.image_url }}" >         
          <p class="author">Autor: {{ article.autor.username }}</p>
          <p class="description">{{ article.description }}</p>
          <div class="article-actions">
            <span><i class="fas fa-eye"></i> {{ article.views_number }}</span>
            <span><i class="fas fa-share"></i> {{ article.shares_number }}</span>
            <span><i class="fas fa-thumbs-up"></i> {{ article.likes_number }}</span>
            <span><i class="fas fa-thumbs-down"></i> {{ article.dislikes_number }}</span>
            <span>
          </div>

          <div class="article-tags">
            <strong>Tags:</strong>
            {% if article.tags.all %}
              {% for tag in article.tags.all %}
                <span class="tag">{{ tag.name }}</span>
              {% endfor %}
            {% else %}
              No hay tags asignados
            {% endif %}
          </div>

          <div>
            <p>Promedio de calificaci√≥n: 
            {% if article.avg_rating %}
              {{ article.avg_rating }} estrellas
            {% else %}
              No calificado
            {% endif %}
            </p>
          </div>
          
        </div>
        {% endfor %}
      {% else %}
        <!-- Mostrar un mensaje si no se encuentran art√≠culos -->
        <p class="no-results-message">No se encontraron art√≠culos que coincidan con los filtros aplicados.</p>
      {% endif %}
    </section>
    <aside class="categories">
      <form method="get" action="{% url 'home' %}" class="search-form">
        <input 
            type="text" 
            name="search" 
            placeholder="Buscar art√≠culos..." 
            value="{{ search_query }}" 
            class="search-input">
        <button type="submit" class="search-button">
            <i class="fas fa-search"></i>
        </button>
        </form>
        <div class="category-section">
            <h3>Categor√≠as - Free</h3>
            {% for category in permited_categories %}
              {% if category.type == 'free' %}
                {% if 'ver_categorias_suscriptor' in permisos%}
                  <div class="category-header">
                    <p class="category-name">{{ category.name }}</p>
                    <button class="favorite-btn" data-category-id="{{ category.id }}">
                      {% if category.id in favorite_categories %}
                          üíñ
                      {% else %}
                          ü§ç
                      {% endif %}
                    </button>
                  </div>
                {% else %}
                  <p class="category-name">{{ category.name }}</p>
                {% endif %}
              {% endif %}
            {% endfor %}
        </div>
        <div class="category-section">
            <h3>Categor√≠as - Suscriptor</h3>
            {% for category in permited_categories %}
              {% if category.type == 'suscription' %}
                <div class="category-header">
                  <p class="category-name">{{ category.name }}</p>
                  <button class="favorite-btn" data-category-id="{{ category.id }}">
                    {% if category.id in favorite_categories %}
                        üíñ
                    {% else %}
                        ü§ç
                    {% endif %}
                  </button>
                </div>
              {% endif %}
            {% endfor %}
            {% for category in not_permited_categories %}
              {% if category.type == 'suscription' %} 
                <p>üîí {{category.name}}</p>
              {% endif %}
            {% endfor %}
        </div>
        <div class="category-section">
            <h3>Categor√≠as - Pagas</h3>
            {% for category in permited_categories %}
              {% if category.type == 'pay' %}
                <div class="category-header">
                  <p class="category-name">{{ category.name }}</p>
                  <button class="favorite-btn" data-category-id="{{ category.id }}">
                    {% if category.id in favorite_categories %}
                        üíñ
                    {% else %}
                        ü§ç
                    {% endif %}
                  </button>
                </div>
              {% endif %}
            {% endfor %}

            {% for category in not_permited_categories %}
              {% if category.type == 'pay' %} 
              <p>üîí {{category.name}}</p>
              {% endif %}
            {% endfor %}
        </div>
    </aside>
  {% endif %}
  <!-- Atriculos de categorias no favoritas -->
  {% if normal_articles %}
    <section class="articles">
      {% if 'ver_categorias_suscriptor' in permisos and favorite_categories and favorite_articles%}
        <div class="section-header normal-header">
          <h3>Art√≠culos de Otras Categor√≠as</h3>
        </div>
      {% else %}
        <div class="section-header normal-header">
          <h3>Todos los Art√≠culos</h3>
        </div>
      {% endif %}
      {% for article in normal_articles %}
      <div class="article-card">
        <a href="{% url 'article-detail' article.id %}?from=home">
          <h2 class="article-title">{{ article.title }}</h2>
        </a>        
        <img class="articulos" src="{{ article.image_url }}" >
        <p class="author">Autor: {{ article.autor.username }}</p>
        <p class="description">{{ article.description }}</p>
        <div class="article-actions">
          <span><i class="fas fa-eye"></i> {{ article.views_number }}</span>
          <span><i class="fas fa-share"></i> {{ article.shares_number }}</span>
          <span><i class="fas fa-thumbs-up"></i> {{ article.likes_number }}</span>
          <span><i class="fas fa-thumbs-down"></i> {{ article.dislikes_number }}</span>
          <span>
        </div>

        <div class="article-tags">
          <strong>Tags:</strong>
          {% if article.tags.all %}
            {% for tag in article.tags.all %}
              <span class="tag">{{ tag.name }}</span>
            {% endfor %}
          {% else %}
            No hay tags asignados
          {% endif %}
        </div>

        <div>
          <p>Promedio de calificaci√≥n: 
          {% if article.avg_rating %}
            {{ article.avg_rating }} estrellas
          {% else %}
            No calificado
          {% endif %}
          </p>
        </div>
        
      </div>
      {% endfor %}
    </section>
  {% endif %}
  {% if 'ver_categorias_suscriptor' not in permisos or not favorite_categories or not favorite_articles %}
    <aside class="categories">
      <form method="get" action="{% url 'home' %}" class="search-form">
        <input 
            type="text" 
            name="search" 
            placeholder="Buscar art√≠culos..." 
            value="{{ search_query }}" 
            class="search-input">
        <button type="submit" class="search-button">
            <i class="fas fa-search"></i>
        </button>
        </form>
        <div class="category-section">
            <h3>Categor√≠as - Free</h3>
            {% for category in permited_categories %}
              {% if category.type == 'free' %}
                {% if 'ver_categorias_suscriptor' in permisos%}
                  <div class="category-header">
                    <p class="category-name">{{ category.name }}</p>
                    <button class="favorite-btn" data-category-id="{{ category.id }}">
                      {% if category.id in favorite_categories %}
                          üíñ
                      {% else %}
                          ü§ç
                      {% endif %}
                    </button>
                  </div>
                {% else %}
                  <p class="category-name">{{ category.name }}</p>
                {% endif %}
              {% endif %}
            {% endfor %}
        </div>
        <div class="category-section">
            <h3>Categor√≠as - Suscriptor</h3>
            {% for category in permited_categories %}
              {% if category.type == 'suscription' %}
                <div class="category-header">
                  <p class="category-name">{{ category.name }}</p>
                  <button class="favorite-btn" data-category-id="{{ category.id }}">
                    {% if category.id in favorite_categories %}
                        üíñ
                    {% else %}
                        ü§ç
                    {% endif %}
                  </button>
                </div>
              {% endif %}
            {% endfor %}
            {% for category in not_permited_categories %}
              {% if category.type == 'suscription' %} 
                <p>üîí {{category.name}}</p>
              {% endif %}
            {% endfor %}
        </div>
        <div class="category-section">
            <h3>Categor√≠as - Pagas</h3>
            {% for category in permited_categories %}
              {% if category.type == 'pay' %}
                <div class="category-header">
                  <p class="category-name">{{ category.name }}</p>
                  <button class="favorite-btn" data-category-id="{{ category.id }}">
                    {% if category.id in favorite_categories %}
                        üíñ
                    {% else %}
                        ü§ç
                    {% endif %}
                  </button>
                </div>
              {% endif %}
            {% endfor %}

            {% for category in not_permited_categories %}
              {% if category.type == 'pay' %} 
              <p>üîí {{category.name}}</p>
              {% endif %}
            {% endfor %}
        </div>
    </aside>
  {% endif %}
{% endif %}

</main>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var filterButton = document.getElementById('filterToggle');
    var filterPanel = document.getElementById('filterPanel');
    
    // Alternar el cuadro de filtros cuando se hace clic en el bot√≥n
    filterButton.addEventListener('click', function() {
      if (filterPanel.style.display === 'none' || filterPanel.style.display === '') {
        filterPanel.style.display = 'block';
      } else {
        filterPanel.style.display = 'none';
      }
    });
  });

  // Funci√≥n que actualiza los par√°metros de la URL al cambiar filtros
  function applyFilters(orderDirection = "desc") {
    const url = new URL(window.location.href);
    const searchInput = document.querySelector('input[name="search"]').value;
    const orderBy = document.querySelector('select[name="order_by"]').value;
    const timeRange = document.querySelector('select[name="time_range"]').value;

    // Obtener los valores de tags, categor√≠as y tipo de categor√≠a
    const category = document.querySelector('select[name="category"]').value;
    const tag = document.querySelector('select[name="tags"]').value;
    const categoryType = document.querySelector('select[name="category_type"]').value;

    // Actualiza los par√°metros en la URL
    url.searchParams.set('search', searchInput);
    url.searchParams.set('order_by', orderBy);
    url.searchParams.set('time_range', timeRange);
    url.searchParams.set('order_direction', orderDirection);

    // Asegurarse de mantener los par√°metros de tags, categor√≠as y tipo de categor√≠a
    url.searchParams.set('category', category);
    url.searchParams.set('tag', tag);
    url.searchParams.set('category_type', categoryType);

    // Redirige con los nuevos par√°metros
    window.location.href = url;
  }

  // Funci√≥n para alternar entre ascendente y descendente
  function toggleOrderDirection() {
    const url = new URL(window.location.href);
    const currentOrderDirection = url.searchParams.get('order_direction') || 'desc';
    const newOrderDirection = currentOrderDirection === 'asc' ? 'desc' : 'asc';

    // Luego aplica los filtros manteniendo el nuevo valor de order_direction
    applyFilters(newOrderDirection);
  }
</script>

<!-- Para marcar como favorito-->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const favoriteButtons = document.querySelectorAll('.favorite-btn');

    favoriteButtons.forEach(button => {
      button.addEventListener('click', function() {
        const categoryId = this.getAttribute('data-category-id');
        
        fetch("{% url 'toggle-favorite-category' 0 %}".replace('/0/', `/${categoryId}/`), {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
          },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'added') {
                this.innerHTML = 'üíñ';
            } else if (data.status === 'removed') {
                this.innerHTML = 'ü§ç';
            }
        });
      });
    });
  });

  let slideIndex = 1;
  slideTimer = setTimeout(plusSlides, 5000)

  showSlides(slideIndex);

  // Next/previous controls
  function plusSlides(n=1) {
    showSlides(slideIndex += n);
  }

  // Thumbnail image controls
  function currentSlide(n) {
    showSlides(slideIndex = n);
  }

  function showSlides(n) {
    clearTimeout(slideTimer)
    let i;
    let slides = document.getElementsByClassName("mySlides");
    let dots = document.getElementsByClassName("dot");
    if (n > slides.length) {
      slideIndex = 1
    } else if (n < 1) {
      slideIndex = slides.length
    }

    for (i = 0; i < slides.length; i++) {
      slides[i].style.display = "none";
    }
    for (i = 0; i < dots.length; i++) {
      dots[i].className = dots[i].className.replace(" active", "");
    }
    slides[slideIndex-1].style.display = "block";
    dots[slideIndex-1].className += " active";

    slideTimer = setTimeout(plusSlides, 5000)
  }
</script>
{% endblock content %}