{% extends 'base.html' %}

{% block content %}
<h2>Lista de Categorías Vendidas</h2>

<!-- Filter Form -->
<div>
    <label for="filter_start_date">Desde:</label>
    <input type="date" id="filter_start_date">
    
    <label for="filter_end_date">Hasta:</label>
    <input type="date" id="filter_end_date">
    
    <label for="filter_category">Categoría:</label>
    <select id="filter_category">
        <option value="">Todas</option>
        {% for category in all_categories %}
            <option value="{{ category.name }}">{{ category.name }}</option>
        {% endfor %}
    </select>
    
    <label for="filter_username">Usuario:</label>
    <select id="filter_username">
        <option value="">Todos</option>
        {% for user in all_users %}
            <option value="{{ user.username }}">{{ user.username }}</option>
        {% endfor %}
    </select>
    
    <button type="button" onclick="applyFilters()">Filtrar</button>
</div>

<!-- Table for Displaying Sold Categories -->
<table id="category_table">
    <thead>
        <tr>
            <th>Categoría</th>
            <th>Ventas</th>
            <th>Ganancias</th>
            <th>Compradores (Fecha y Hora)</th>
        </tr>
    </thead>
    <tbody>
        {% for category, sales, earning, buyers in category_data %}
        <tr>
            <td>{{ category }}</td>
            <td>{{ sales }}</td>
            <td class="earning">${{ earning }}</td>
            <td>
                {% for buyer in buyers %}
                    <div class="buyer-info">{{ buyer }}</div>
                {% endfor %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<p><strong>Total de Ganancias:</strong> $<span id="total_earnings">{{ total_general }}</span></p>

<div class="download-button-container">
    <form method="GET" action="{% url 'download-sold-categories' %}">
        <input type="hidden" name="start_date" id="download_start_date">
        <input type="hidden" name="end_date" id="download_end_date">
        <input type="hidden" name="category_name" id="download_category_name">
        <input type="hidden" name="username" id="download_username">
        <button type="submit" class="btn btn-primary">Descargar lista de categorías vendidas</button>
    </form>
</div>

<style>
    .download-button-container {
        margin-top: 20px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
    }
</style>

<script>
function applyFilters() {
    console.log("applyFilters function called");

    const startDateStr = document.getElementById("filter_start_date").value;
    const endDateStr = document.getElementById("filter_end_date").value;
    const selectedCategory = document.getElementById("filter_category").value.toLowerCase();
    const selectedUsername = document.getElementById("filter_username").value.toLowerCase();

    const startDate = startDateStr ? new Date(startDateStr) : null;
    const endDate = endDateStr ? new Date(endDateStr) : null;

    const rows = document.querySelectorAll("#category_table tbody tr");
    let totalEarnings = 0;

    rows.forEach(row => {
        const category = row.cells[0].textContent.toLowerCase();
        const buyers = row.cells[3].querySelectorAll(".buyer-info");

        let rowEarnings = 0;
        let rowSales = 0;
        let showRow = false;

        // Filtrar por categoría
        if (selectedCategory && selectedCategory !== category) {
            row.style.display = "none";
            return; // Saltar al siguiente row si la categoría no coincide
        }

        buyers.forEach(buyer => {
            const buyerText = buyer.textContent.toLowerCase();
            const dateMatch = buyerText.match(/fecha: (\d{4}-\d{2}-\d{2})/);
            const buyerDate = dateMatch ? new Date(dateMatch[1]) : null;

            const buyerDateString = buyerDate ? buyerDate.toISOString().split('T')[0] : null;
            const startDateString = startDate ? startDate.toISOString().split('T')[0] : null;
            const endDateString = endDate ? endDate.toISOString().split('T')[0] : null;

            // Filtrar por usuario
            if (selectedUsername && !buyerText.includes(selectedUsername)) {
                buyer.style.display = "none";
                return;
            }

            // Filtrar por fecha
            if (startDate && endDate && buyerDateString) {
                if (buyerDateString < startDateString || buyerDateString > endDateString) {
                    buyer.style.display = "none";
                    return;
                }
            }

            // Si el comprador pasa todos los filtros, hacerlo visible y contar la ganancia y venta
            buyer.style.display = "";
            showRow = true;

            // Sumar ganancias y ventas para el comprador visible
            rowEarnings += 5; // Ajuste basado en el costo de cada comprador visible
            rowSales += 1;
        });

        // Mostrar u ocultar la fila según si hay compradores visibles que cumplen los filtros
        row.style.display = showRow ? "" : "none";

        // Actualizar las celdas de ventas y ganancias de la fila actual
        row.cells[1].textContent = showRow ? rowSales : 0;
        row.cells[2].textContent = showRow ? `$${rowEarnings.toFixed(2)}` : "$0.00";

        // Sumar ganancias solo para las filas que cumplen los filtros
        if (showRow) {
            totalEarnings += rowEarnings;
        }
    });

    // Actualizar el total de ganancias en el HTML
    document.getElementById("total_earnings").textContent = totalEarnings.toFixed(2);
}
</script>
{% endblock %}
